# 工控系统点表管理软件V1.0 - 功能梳理文档

## 项目概述

工控系统点表管理软件V1.0是一个专为工业自动化项目深化设计阶段开发的综合性数据管理平台。该软件采用Python + PySide6技术栈，集成了项目数据查询、PLC硬件配置、第三方设备管理、IO点表生成等核心功能，大幅提升了工程师的工作效率。

### 技术架构
- **界面框架**: PySide6 (Qt6)
- **数据库**: SQLite3
- **数据处理**: Pandas, openpyxl
- **架构模式**: MVC + 服务层模式
- **设计原则**: 分层架构、模块化设计、统一数据模型

## 核心功能模块

### 1. 数据查询与获取模块

#### 1.1 简道云API集成
**文件位置**: `core/query_area/jiandaoyun_api.py`

**主要功能**:
- 与简道云API深度集成，实现实时数据同步
- 支持按项目编号快速检索项目信息
- 批量数据获取，支持分页查询
- 场站设备数据查询

**核心方法**:
- `query_data()`: 查询项目数据，支持项目编号过滤
- `query_site_devices()`: 获取指定场站的设备清单数据
- 支持100条/批次的API限制处理

**配置参数**:
```ini
[JianDaoYun]
api_base_url = https://api.jiandaoyun.com/api/v5
api_key = [API密钥]
app_id = [应用ID]
entry_id = [表单ID]
```

#### 1.2 项目数据查询服务
**文件位置**: `core/project_list_area/project_service.py`

**主要功能**:
- 从简道云获取项目数据的标准化处理
- 项目列表数据的格式化和展示
- 查询结果的临时缓存管理
- 为UI层提供格式化的项目数据

#### 1.3 设备数据查询服务
**文件位置**: `core/device_list_area/device_service.py`

**主要功能**:
- 从简道云获取设备清单数据
- 设备信息的标准化和过滤处理
- 和利时产品的智能识别和分类
- 为UI层提供格式化的设备数据

### 2. PLC硬件配置模块

#### 2.1 PLC配置核心引擎
**文件位置**: `core/io_table/get_data.py`

**主要功能**:
- **模块信息管理**: 支持和利时LK/LE系列PLC模块的完整定义
- **系统类型检测**: 自动识别LK系统和LE_CPU系统
- **配置验证**: 智能验证模块配置的合法性
- **地址生成**: 自动生成IO通道地址映射

**核心类**:
- `ModuleInfoProvider`: 模块信息提供者
- `PLCConfigurationHandler`: PLC配置处理器
- `SystemSetupManager`: 系统配置管理器
- `IODataLoader`: 统一数据加载器

**验证规则**:
- LK系统槽位1只能放DP模块
- LE_CPU系统槽位1必须是LE5118 CPU
- 模块兼容性检查
- 机架容量限制验证

#### 2.2 配置持久化
**文件位置**: `core/io_table/plc_config_persistence.py`

**主要功能**:
- 场站配置的自动保存和加载
- 配置文件的版本管理
- 自动备份机制
- 跨场站配置切换

**存储格式**:
```json
{
  "site_name": "场站名称",
  "save_time": "2024-01-01T12:00:00",
  "version": "1.1",
  "config": {"1,2": "LK610S"},
  "system_info": {...},
  "rack_configurations": {...}
}
```

#### 2.3 现代化PLC配置界面
**文件位置**: `ui/components/plc_config/`

**主要功能**:
- **穿梭框设计**: 直观的模块选择和配置界面
- **拖拽支持**: 支持模块的拖拽操作
- **实时验证**: 配置过程中的实时合法性检查
- **机架可视化**: 直观显示机架和槽位状态

**组件结构**:
- `plc_config_widget.py`: 主配置界面
- `enhanced_transfer_widget.py`: 增强型穿梭框
- `rack_widget.py`: 机架显示组件
- `plc_config_adapter.py`: 兼容性适配器

### 3. 第三方设备管理模块

#### 3.1 设备模板管理
**文件位置**: `core/third_party_config_area/template_service.py`

**主要功能**:
- 设备点表模板的创建和管理
- 模板的CRUD操作
- 模板数据的验证和标准化

#### 3.2 设备配置服务
**文件位置**: `core/third_party_config_area/config_service.py`

**主要功能**:
- 基于模板的设备实例配置
- 批量设备配置
- 配置数据的持久化存储

**核心方法**:
- `save_device_configuration()`: 保存设备配置
- `get_all_configured_devices()`: 获取所有已配置设备
- `delete_device_configuration()`: 删除设备配置

#### 3.3 数据访问层
**文件位置**: `core/third_party_config_area/database/`

**主要功能**:
- SQLite数据库操作封装
- 设备模板和配置的数据持久化
- 数据完整性保证

### 4. IO点表处理模块

#### 4.1 文件上传和解析
**文件位置**: `core/post_upload_processor/uploaded_file_processor/`

**主要功能**:
- **Excel统一读取器**: 支持.xls和.xlsx格式
- **标准数据模型**: 基于`UploadedIOPoint`的统一数据流
- **多工作表处理**: 支持复杂Excel文件的多工作表解析

**核心类**:
- `ExcelReader`: Excel文件读取器
- `UploadedIOPoint`: 标准IO点位数据模型

#### 4.2 数据校验引擎
**文件位置**: `core/post_upload_processor/io_validation/`

**主要功能**:
- IO点表格式验证
- 数据完整性检查
- 业务规则验证
- 错误信息收集和报告

**验证规则**:
- 必填字段检查
- 数据类型验证
- 业务逻辑校验
- 重复数据检测

### 5. 点表生成模块

#### 5.1 PLC点表生成器

##### 5.1.1 和利时PLC生成器
**文件位置**: `core/post_upload_processor/plc_generators/hollysys_generator/`

**主要功能**:
- **标准型生成器** (`generator.py`): 生成标准和利时PLC点表
- **安全型生成器** (`safety_generator.py`): 生成安全型PLC点表
- **Modbus表生成**: 生成Modbus通讯点表

**生成格式**:
- 变量表 (.xls格式)
- Modbus表 (线圈和保持寄存器)
- 支持多工作表输出

##### 5.1.2 中控PLC生成器
**状态**: 功能待实现
**计划功能**: 支持中控PLC点表生成

#### 5.2 HMI点表生成器

##### 5.2.1 亚控组态生成器
**文件位置**: `core/post_upload_processor/hmi_generators/yk_generator/`

**主要功能**:
- 生成亚控组态软件兼容的点表文件
- 支持IO服务器配置文件
- 支持数据词典文件
- 自动点位地址分配

**输出文件**:
- IO服务器文件
- 数据词典文件

##### 5.2.2 力控组态生成器
**文件位置**: `core/post_upload_processor/hmi_generators/lk_generator/`

**主要功能**:
- 生成力控组态软件兼容的CSV文件
- 支持多种配置文件类型

**输出文件**:
- `Basic.csv`: 基础配置文件
- `His.csv`: 历史配置文件  
- `Link.csv`: 链接配置文件

#### 5.3 FAT测试点表生成器
**文件位置**: `core/post_upload_processor/fat_generators/`

**主要功能**:
- 基于原始IO点表生成FAT测试清单
- 自动处理预留点位
- 保留原始Excel格式和公式
- 自动填充HMI变量名和描述

**处理逻辑**:
- 识别空白的HMI变量名和描述字段
- 根据通道位号自动生成预留点位标识
- 使用openpyxl保持文件格式完整性

### 6. 用户界面模块

#### 6.1 主窗口
**文件位置**: `ui/main_window.py`

**主要功能**:
- 标签页式界面布局
- 功能模块的统一管理
- 状态栏信息显示
- 菜单和工具栏管理

**界面结构**:
- 数据查询标签页
- PLC硬件配置标签页
- 第三方设备配置标签页

#### 6.2 查询区域组件
**文件位置**: `ui/components/query_area.py`

**主要功能**:
- 项目编号和场站编号输入
- 查询条件设置
- IO点表状态显示
- 操作按钮管理

#### 6.3 项目列表组件
**文件位置**: `ui/components/project_list_area.py`

**主要功能**:
- 项目信息的表格展示
- 项目选择和切换
- 数据更新状态管理

**显示字段**:
- 项目名称
- 场站
- 项目编号
- 深化设计编号
- 客户名称

#### 6.4 设备列表组件
**文件位置**: `ui/components/device_list_area.py`

**主要功能**:
- 设备清单的表格展示
- 设备信息的详细显示
- 设备筛选和排序

**显示字段**:
- 设备名称
- 品牌
- 规格型号
- 技术参数
- 数量
- 单位
- 技术参数(外部)

#### 6.5 第三方设备配置组件
**文件位置**: `ui/components/third_party_device_area.py`

**主要功能**:
- 设备模板管理界面
- 设备实例配置界面
- 点位属性设置

### 7. 配置管理

#### 7.1 全局配置
**文件位置**: `config.ini`

**配置项目**:
- 数据库配置
- PLC地址生成配置
- UI界面设置
- 导出文件配置
- 日志配置
- 简道云API配置

#### 7.2 PLC模块定义
**文件位置**: `db/plc_modules.json`

**主要内容**:
- 和利时LK/LE系列模块定义
- 模块类型和规格
- IO通道配置
- 兼容性信息

### 8. 数据存储

#### 8.1 SQLite数据库
**文件位置**: `db/data.db`

**主要表结构**:
- 用户和权限管理
- 项目和场站信息
- 设备配置数据
- 第三方设备模板和实例

#### 8.2 配置文件存储
**文件位置**: `db/plc_configs/`

**存储内容**:
- 场站PLC配置文件
- 配置历史备份
- 版本管理信息

## 工作流程

### 1. 典型使用流程

1. **项目数据查询**
   - 输入项目编号
   - 查询项目列表
   - 选择具体场站
   - 获取设备清单

2. **PLC硬件配置**
   - 切换到PLC配置标签页
   - 使用穿梭框选择模块
   - 配置机架和槽位
   - 验证配置合法性
   - 保存配置

3. **第三方设备配置**
   - 创建或选择设备模板
   - 配置设备实例
   - 设置点位属性
   - 保存配置

4. **IO点表处理**
   - 上传IO点表Excel文件
   - 系统自动校验格式
   - 选择目标生成格式
   - 生成并下载点表文件

### 2. 数据流转

```
简道云API → 项目数据查询 → 标准化处理 → 项目列表展示
         ↓
         设备数据查询 → 标准化处理 → 设备清单展示
                                    ↓
Excel文件 → 解析验证 → UploadedIOPoint → 点表生成器 → 输出文件
                                    ↓
PLC配置 → 验证保存 → 地址生成 → 配置文件存储
```

## 扩展性设计

### 1. 插件化架构准备
- 清晰的接口定义
- 模块化的代码结构
- 配置驱动的功能开关

### 2. 支持的扩展点
- 新PLC品牌支持
- 新HMI软件支持
- 新数据源集成
- 新文件格式处理

### 3. 配置化功能
- UI组件的可配置切换
- 生成器的插件式加载
- 验证规则的可配置化

## 技术特色

### 1. 统一数据模型
- 基于`UploadedIOPoint`的标准化数据流
- 支持多种数据源的统一处理
- 保证数据一致性和完整性

### 2. 智能配置验证
- 实时的PLC配置合法性检查
- 业务规则的自动验证
- 用户友好的错误提示

### 3. 现代化UI设计
- 响应式布局设计
- 拖拽和动画效果
- 键盘快捷键支持

### 4. 数据持久化
- 自动配置保存
- 版本管理和备份
- 跨场站配置切换

## 性能优化

### 1. 数据处理优化
- 批量数据处理
- 内存使用优化
- 异步操作支持

### 2. UI响应优化
- 懒加载机制
- 数据缓存策略
- 进度指示器

### 3. 文件处理优化
- 大文件分块处理
- 格式兼容性保证
- 错误恢复机制

## 质量保证

### 1. 错误处理
- 完善的异常捕获
- 用户友好的错误提示
- 详细的日志记录

### 2. 数据验证
- 多层次的数据校验
- 业务规则验证
- 数据完整性检查

### 3. 测试覆盖
- 单元测试框架
- 集成测试用例
- 用户验收测试

## 重构建议

### 1. 架构升级方向

#### 1.1 前后端分离
- **前端**: 采用Angular框架，提供现代化的Web界面
- **后端**: 采用Rust语言，提供高性能的API服务
- **优势**: 更好的可维护性、扩展性和部署灵活性

#### 1.2 插件化架构
- **PLC插件系统**: 支持多品牌PLC的插件式扩展
- **HMI插件系统**: 支持多种HMI软件的插件式支持
- **数据源插件**: 支持简道云、自定义API、数据库等多种数据源的统一接入
- **文件处理插件**: 支持多种文件格式的处理

#### 1.3 微服务架构
- **核心服务**: 项目管理、设备管理、配置管理
- **处理服务**: 文件处理、数据验证、点表生成
- **集成服务**: 第三方API集成、AI服务集成

### 2. 技术栈升级

#### 2.1 后端技术栈
- **主语言**: Rust (高性能、内存安全)
- **Web框架**: Axum 或 Actix-web
- **数据库**: PostgreSQL (生产环境) + SQLite (开发环境)
- **缓存**: Redis
- **消息队列**: RabbitMQ 或 Apache Kafka

#### 2.2 前端技术栈
- **框架**: Angular 17+
- **UI库**: Angular Material 或 PrimeNG
- **状态管理**: NgRx
- **图表库**: Chart.js 或 D3.js
- **文件处理**: 支持拖拽上传、预览

#### 2.3 部署和运维
- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (可选)
- **CI/CD**: GitHub Actions 或 GitLab CI
- **监控**: Prometheus + Grafana

### 3. 功能增强建议

#### 3.1 用户体验优化
- **响应式设计**: 支持多种屏幕尺寸
- **国际化支持**: 中英文切换
- **主题切换**: 明暗主题支持
- **快捷键**: 完整的键盘操作支持

#### 3.2 数据处理增强
- **批量操作**: 支持批量项目处理
- **数据导入导出**: 支持多种格式的数据交换
- **版本控制**: 配置和数据的版本管理
- **审计日志**: 完整的操作记录

#### 3.3 集成能力扩展
- **AI集成**: 支持AI读取设计文件
- **API开放**: 提供RESTful API供第三方集成
- **Webhook支持**: 支持事件通知
- **SSO集成**: 支持企业单点登录

### 4. 迁移策略

#### 4.1 渐进式迁移
1. **第一阶段**: 保持现有功能，重构后端API
2. **第二阶段**: 开发新前端界面，与新API集成
3. **第三阶段**: 实现插件系统，迁移现有生成器
4. **第四阶段**: 添加新功能，优化用户体验

#### 4.2 数据迁移
- **配置迁移**: 现有PLC配置和第三方设备配置
- **用户数据迁移**: 项目数据和用户偏好设置
- **模板迁移**: 设备模板和点表模板

#### 4.3 兼容性保证
- **文件格式兼容**: 保持对现有Excel文件的支持
- **API兼容**: 提供兼容层支持现有集成
- **配置兼容**: 支持现有配置文件的导入

## 总结

工控系统点表管理软件V1.0是一个功能完整、架构清晰的工业软件系统。它成功地解决了工程师在项目深化设计阶段的核心需求，提供了从数据查询到点表生成的完整工作流程。

### 主要优势
1. **功能完整**: 覆盖了工控项目的核心业务流程
2. **架构清晰**: 分层设计，模块化实现
3. **扩展性好**: 为插件化架构奠定了基础
4. **用户友好**: 现代化的UI设计和交互体验

### 改进空间
1. **技术栈现代化**: 向Web技术栈迁移
2. **架构升级**: 实现真正的插件化架构
3. **性能优化**: 支持更大规模的数据处理
4. **集成能力**: 更好的第三方系统集成

这个功能梳理文档为后续的重构工作提供了完整的参考基础，确保在技术升级的同时保持业务功能的连续性和完整性。
