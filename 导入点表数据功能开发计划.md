# 导入点表数据功能开发计划

## 项目概述

**目标**：添加一个独立的导入点表数据功能，让系统能够从现有点表文件中自动获取数据来填充IO点表模板中原本需要手动填写的灰色部分。

**核心原则**：
- 完全不影响现有功能
- 作为独立的辅助工具实现
- 保持现有工作流程不变

## 方案一：独立导入填充功能

### 工作流程
```
生成IO点表模板 → 点击"导入点表数据" → 选择现有点表文件 → 
系统自动匹配和填充 → 生成新的已填充文件 → 用户检查确认 → 
可选择上传验证或继续手动调整
```

## 详细开发步骤

### 第一阶段：UI界面准备（1-2小时）

#### 步骤1：添加导入按钮
**文件位置**：`ui/main_window.py`

**任务内容**：
- 在 `__init__` 方法中创建"导入点表数据"按钮
- 设置按钮样式和提示文本
- 将按钮添加到现有按钮布局中（放在"上传IO点表"按钮旁边）
- 连接按钮点击事件到处理方法

**代码位置**：
```python
# 在 __init__ 中添加
self.import_point_data_btn = QPushButton("导入点表数据")
self.import_point_data_btn.setToolTip("导入现有点表数据来自动填充IO点表模板中的灰色部分")

# 在 setup_connections 中添加
self.import_point_data_btn.clicked.connect(self._handle_import_point_data)
```

#### 步骤2：添加按钮状态控制
**任务内容**：
- 只有在PLC配置完成且有当前场站时才启用按钮
- 在相关状态变化时更新按钮状态
- 添加相应的状态检查逻辑

### 第二阶段：核心功能实现（4-6小时）

#### 步骤3：实现导入文件选择和验证
**方法名**：`_handle_import_point_data(self)`

**任务内容**：
1. 检查前置条件（PLC配置、当前场站）
2. 打开文件选择对话框
3. 验证选择的文件格式和内容
4. 调用核心处理逻辑

**关键检查点**：
- `self.io_data_loader` 和 `self.io_data_loader.current_plc_config` 存在
- `self.current_site_name` 不为空
- 选择的文件通过 `validate_io_table()` 验证

#### 步骤4：实现模板数据生成
**方法名**：`_generate_template_for_import(self) -> Optional[List[Dict[str, Any]]]`

**任务内容**：
1. 获取当前PLC配置
2. 生成IO点表模板数据（复用现有的生成模板逻辑）
3. 返回结构化的模板数据

**实现要点**：
- 复用 `self.io_data_loader.get_channel_addresses()` 方法
- 确保生成的数据格式与现有导出格式一致

#### 步骤5：实现数据匹配和映射
**方法名**：`_map_and_fill_template_data(self, template_data, import_data)`

**任务内容**：
1. 解析导入文件中的点位数据
2. 建立匹配索引（按HMI变量名、描述等）
3. 执行数据匹配和填充
4. 返回填充后的数据

**匹配策略**：
```python
# 优先级匹配顺序
1. 精确匹配：HMI变量名完全相同
2. 描述匹配：变量描述完全相同  
3. 模糊匹配：去除空格、大小写后匹配
4. 部分匹配：包含关系匹配
```

#### 步骤6：实现字段填充逻辑
**方法名**：`_fill_point_from_import(self, template_point, import_point)`

**任务内容**：
- 定义字段映射关系
- 只填充用户输入字段（灰色部分）
- 保持原有数据优先级

**字段映射配置**：
```python
FIELD_MAPPINGS = {
    'power_supply_type': '供电类型（有源/无源）',
    'wiring_system': '线制', 
    'hmi_variable_name': '变量名称（HMI）',
    'variable_description': '变量描述',
    'range_low_limit': '量程下限',
    'range_high_limit': '量程上限',
    'sll_set': 'SLL设定值',
    'sl_set': 'SL设定值', 
    'sh_set': 'SH设定值',
    'shh_set': 'SHH设定值',
    'units': '单位'
}
```

### 第三阶段：文件保存和用户交互（2-3小时）

#### 步骤7：实现填充结果保存
**方法名**：`_save_filled_template(self, filled_data, import_file_path)`

**任务内容**：
1. 生成输出文件名
2. 使用现有的 `IOExcelExporter` 保存文件
3. 保存到"IO点表模板"目录

**文件命名规则**：
```python
"{场站名}_IO_点表_导入填充_{原文件名}.xlsx"
```

#### 步骤8：添加用户反馈和确认
**任务内容**：
- 显示匹配统计信息（成功匹配 X/Y 个点位）
- 询问是否打开文件所在文件夹
- 提供操作成功/失败的明确反馈

### 第四阶段：错误处理和日志（1-2小时）

#### 步骤9：完善错误处理
**错误场景**：
- 文件读取失败处理
- 数据格式不匹配处理
- 保存文件失败处理
- 用户取消操作处理

#### 步骤10：添加详细日志
**日志内容**：
- 记录导入过程的关键步骤
- 记录匹配成功/失败的统计
- 记录错误信息便于调试

### 第五阶段：测试和优化（2-3小时）

#### 步骤11：功能测试
**测试用例**：
- 测试正常导入流程
- 测试各种异常情况
- 测试不同格式的点表文件
- 验证不影响现有功能

#### 步骤12：用户体验优化
**优化内容**：
- 优化匹配算法准确率
- 改进用户提示信息
- 添加进度指示器（如果需要）

## 关键技术点

### 数据匹配索引构建
```python
# 创建多重索引提高匹配成功率
import_index = {}
for point in all_import_points:
    # 主键：HMI变量名
    if point.hmi_variable_name:
        import_index[point.hmi_variable_name.strip()] = point
    # 备用键：变量描述
    if point.variable_description:
        desc_key = f"desc_{point.variable_description.strip()}"
        import_index[desc_key] = point
```

### 安全的字段填充
```python
# 只在目标字段为空时才填充，保护用户已有数据
if import_value and str(import_value).strip():
    current_value = template_point.get(template_field, '')
    if not current_value or str(current_value).strip() == '':
        template_point[template_field] = str(import_value).strip()
```

## 风险控制措施

1. **功能隔离**：新功能完全独立，不修改现有代码路径
2. **异常处理**：每个步骤都有完整的异常处理
3. **用户确认**：关键操作前都有用户确认
4. **日志记录**：详细记录便于问题排查
5. **渐进开发**：分步骤实现，每步都可以独立测试

## 开发时间预估

| 阶段 | 预估时间 | 累计时间 |
|------|----------|----------|
| UI界面准备 | 1-2小时 | 1-2小时 |
| 核心功能实现 | 4-6小时 | 5-8小时 |
| 文件保存和用户交互 | 2-3小时 | 7-11小时 |
| 错误处理和日志 | 1-2小时 | 8-13小时 |
| 测试和优化 | 2-3小时 | 10-16小时 |

**总计：10-16小时**
- 可以分2-3天完成
- 建议每完成一个阶段就进行测试

## 成功标准

1. ✅ 新功能不影响任何现有功能
2. ✅ 能够成功导入和匹配常见格式的点表数据
3. ✅ 匹配成功率达到80%以上
4. ✅ 用户操作流程简单直观
5. ✅ 错误处理完善，不会导致程序崩溃
6. ✅ 生成的文件格式与现有模板完全兼容

## 后续扩展可能

1. **配置化映射**：允许用户自定义字段映射规则
2. **批量导入**：支持一次导入多个文件
3. **智能匹配**：使用模糊匹配算法提高匹配率
4. **预览功能**：在保存前预览匹配结果
5. **模板管理**：保存和重用导入配置模板
